services:
  control-plane:
    build:
      context: ./control-plane
      dockerfile: Dockerfile
    image: control-plane:latest
    container_name: control-plane
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - CONTROL_PLANE_STORAGE=postgres
      - CONTROL_PLANE_DOCKER=cli
      - EXECUTOR_BASE_URL=http://executor:8090
      - EXECUTOR_AUTH_TOKEN=executor-secret
      - EXECUTOR_TIMEOUT_MS=30000
      - EXECUTOR_MAX_RETRIES=1
      - EXECUTOR_RETRY_DELAY_MS=200
      - EXECUTOR_RETRY_STATUS_CODES=500,502,503,504
      - EXECUTOR_CONTAINER_IMAGE=agent-runtime:latest
      - EXECUTOR_CONTAINER_NETWORK=agent-network
      - PGHOST=pgsql
      - PGPORT=5432
      - PGUSER=app
      - PGPASSWORD=app123456
      - PGDATABASE=app
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - pgsql
      - agent-runtime
      - executor
    networks:
      - agent-network
    restart: always

  executor:
    build:
      context: ./executor
      dockerfile: Dockerfile
    image: executor:latest
    container_name: executor
    ports:
      - "8090:8090"
    environment:
      - EXECUTOR_PORT=8090
      - EXECUTOR_AUTH_TOKEN=executor-secret
      - EXECUTOR_WORKSPACE_ROOT=/tmp/executor-workspaces
      - EXECUTOR_S3_ENDPOINT=http://rustfs:9000
      - EXECUTOR_S3_REGION=us-east-1
      - EXECUTOR_S3_FORCE_PATH_STYLE=true
      - EXECUTOR_S3_ACCESS_KEY=rustfsadmin
      - EXECUTOR_S3_SECRET_KEY=rustfsadmin
      - EXECUTOR_S3_BUCKET=app
    depends_on:
      - rustfs
    networks:
      - agent-network
    restart: always

  agent-runtime:
    build:
      context: .
      dockerfile: ./dockerfile
    image: agent-runtime:latest
    container_name: agent-runtime
    ports:
      - "4096:4096"
    volumes:
      - agent_runtime_data:/data
      - agent_runtime_home:/root
    environment:
      - HTTP_PROXY=http://mihomo:7890
      - HTTPS_PROXY=http://mihomo:7890
      - ALL_PROXY=socks5://mihomo:7890
      - http_proxy=http://mihomo:7890
      - https_proxy=http://mihomo:7890
      - all_proxy=socks5://mihomo:7890
    networks:
      - agent-network
    restart: always

  mihomo:
    container_name: mihomo
    image: yilee01/mihomo-yacd:latest
    volumes:
      - ./mihomo/:/root/.config/mihomo/
    networks:
      - agent-network
    restart: always

  file-manager:
    container_name: file-manager
    image: filebrowser/filebrowser:latest
    user: "0:0"
    environment:
      - FB_NOAUTH=true
      - FB_BASEURL=/file-manager
    command:
      - --address=0.0.0.0
      - --port=80
      - --root=/srv
      - --database=/database/filebrowser.db
      - --config=/config/settings.json
      - --baseurl=/file-manager
    volumes:
      - agent_runtime_srv:/srv
      - agent_runtime_home:/srv/home
      - agent_runtime_data:/srv/data
      - filebrowser_db:/database
      - filebrowser_config:/config
    networks:
      - agent-network
    restart: always

  portal:
    container_name: portal
    build:
      context: ./portal
      dockerfile: Dockerfile
    image: portal:latest
    ports:
      - "80:80"
    depends_on:
      - control-plane
      - file-manager
      - mihomo
    networks:
      - agent-network
    restart: always

  pgsql:
    container_name: pgsql
    image: docker.m.daocloud.io/library/postgres:16-alpine
    environment:
      - POSTGRES_DB=app
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=app123456
    ports:
      - "5432:5432"
    volumes:
      - pgsql_data:/var/lib/postgresql/data
      - ./control-plane/sql/001_init.sql:/docker-entrypoint-initdb.d/001_init.sql:ro
      - ./control-plane/sql/002_rbac_and_file_acl.sql:/docker-entrypoint-initdb.d/002_rbac_and_file_acl.sql:ro
    networks:
      - agent-network
    restart: always

  rustfs:
    container_name: rustfs
    image: rustfs/rustfs:latest
    command: /data
    environment:
      - RUSTFS_ACCESS_KEY=rustfsadmin
      - RUSTFS_SECRET_KEY=rustfsadmin
    ports:
      - "19000:9000"
      - "19001:9001"
    volumes:
      - rustfs_data:/data
    networks:
      - agent-network
    restart: always

networks:
  agent-network:
    driver: bridge

volumes:
  filebrowser_db:
  filebrowser_config:
  agent_runtime_data:
  agent_runtime_home:
  agent_runtime_srv:
  pgsql_data:
  rustfs_data:
