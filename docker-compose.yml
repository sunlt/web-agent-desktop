services:
  control-plane:
    build:
      context: ./control-plane
      dockerfile: Dockerfile
    image: control-plane:latest
    container_name: control-plane
    environment:
      - PORT=3000
      - CONTROL_PLANE_STORAGE=postgres
      - CONTROL_PLANE_DOCKER=cli
      - EXECUTOR_BASE_URL=http://executor:8090
      - EXECUTOR_AUTH_TOKEN=executor-secret
      - EXECUTOR_TIMEOUT_MS=30000
      - EXECUTOR_MAX_RETRIES=1
      - EXECUTOR_RETRY_DELAY_MS=200
      - EXECUTOR_RETRY_STATUS_CODES=500,502,503,504
      - EXECUTOR_CONTAINER_IMAGE=executor:latest
      - EXECUTOR_CONTAINER_NETWORK=agent-network
      - PGHOST=pgsql
      - PGPORT=5432
      - PGUSER=app
      - PGPASSWORD=app123456
      - PGDATABASE=app
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - pgsql
      - executor
    networks:
      - agent-network
    restart: always

  executor:
    build:
      context: .
      dockerfile: ./executor/Dockerfile
    image: executor:latest
    container_name: executor
    ports:
      - "8090:8090"
    environment:
      - EXECUTOR_PORT=8090
      - EXECUTOR_AUTH_TOKEN=executor-secret
      - EXECUTOR_WORKSPACE_ROOT=/tmp/executor-workspaces
      - EXECUTOR_S3_ENDPOINT=http://rustfs:9000
      - EXECUTOR_S3_REGION=us-east-1
      - EXECUTOR_S3_FORCE_PATH_STYLE=true
      - EXECUTOR_S3_ACCESS_KEY=rustfsadmin
      - EXECUTOR_S3_SECRET_KEY=rustfsadmin
      - EXECUTOR_S3_BUCKET=app
    volumes:
      - executor_workspace:/tmp/executor-workspaces
    depends_on:
      - rustfs
    networks:
      - agent-network
    restart: always

  mihomo:
    container_name: mihomo
    image: yilee01/mihomo-yacd:latest
    volumes:
      - ./mihomo/:/root/.config/mihomo/
    networks:
      - agent-network
    restart: always

  file-manager:
    container_name: file-manager
    image: filebrowser/filebrowser:latest
    user: "0:0"
    environment:
      - FB_NOAUTH=true
      - FB_BASEURL=/file-manager
    command:
      - --address=0.0.0.0
      - --port=80
      - --root=/srv
      - --database=/database/filebrowser.db
      - --config=/config/settings.json
      - --baseurl=/file-manager
    volumes:
      - executor_workspace:/srv/executor-workspaces
      - filebrowser_db:/database
      - filebrowser_config:/config
    networks:
      - agent-network
    restart: always

  gateway:
    container_name: gateway
    build:
      context: ./gateway
      dockerfile: Dockerfile
    image: gateway:latest
    ports:
      - "3001:3001"
    environment:
      - GATEWAY_PORT=3001
      - GATEWAY_CONTROL_PLANE_URL=http://control-plane:3000
      - GATEWAY_EXECUTOR_MANAGER_URL=http://executor-manager:3010
      - GATEWAY_UPSTREAM_TIMEOUT_MS=30000
    depends_on:
      - control-plane
      - executor-manager
    networks:
      - agent-network
    restart: always

  executor-manager:
    container_name: executor-manager
    build:
      context: ./executor-manager
      dockerfile: Dockerfile
    image: executor-manager:latest
    ports:
      - "3010:3010"
    environment:
      - EXECUTOR_MANAGER_PORT=3010
      - EXECUTOR_MANAGER_CONTROL_PLANE_URL=http://control-plane:3000
      - EXECUTOR_MANAGER_UPSTREAM_TIMEOUT_MS=30000
    depends_on:
      - control-plane
    networks:
      - agent-network
    restart: always

  portal:
    container_name: portal
    build:
      context: ./portal
      dockerfile: Dockerfile
    image: portal:latest
    ports:
      - "80:80"
    depends_on:
      - gateway
      - executor-manager
      - file-manager
      - mihomo
    networks:
      - agent-network
    restart: always

  pgsql:
    container_name: pgsql
    image: docker.m.daocloud.io/library/postgres:16-alpine
    environment:
      - POSTGRES_DB=app
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=app123456
    ports:
      - "5432:5432"
    volumes:
      - pgsql_data:/var/lib/postgresql/data
      - ./control-plane/sql/001_init.sql:/docker-entrypoint-initdb.d/001_init.sql:ro
      - ./control-plane/sql/002_rbac_and_file_acl.sql:/docker-entrypoint-initdb.d/002_rbac_and_file_acl.sql:ro
      - ./control-plane/sql/003_chat_history.sql:/docker-entrypoint-initdb.d/003_chat_history.sql:ro
    networks:
      - agent-network
    restart: always

  rustfs:
    container_name: rustfs
    image: rustfs/rustfs:latest
    command: /data
    environment:
      - RUSTFS_ACCESS_KEY=rustfsadmin
      - RUSTFS_SECRET_KEY=rustfsadmin
    ports:
      - "19000:9000"
      - "19001:9001"
    volumes:
      - rustfs_data:/data
    networks:
      - agent-network
    restart: always

networks:
  agent-network:
    driver: bridge

volumes:
  filebrowser_db:
  filebrowser_config:
  executor_workspace:
  pgsql_data:
  rustfs_data:
