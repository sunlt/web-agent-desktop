services:
  control-plane:
    build:
      context: ./control-plane
      dockerfile: Dockerfile
    image: control-plane:latest
    container_name: control-plane
    environment:
      - PORT=3000
      - CONTROL_PLANE_STORAGE=postgres
      - CONTROL_PLANE_DOCKER=none
      - CONTROL_PLANE_ENABLE_SESSION_WORKERS_ROUTER=0
      - CONTROL_PLANE_PROVIDER_MODE=${CONTROL_PLANE_PROVIDER_MODE:-real}
      - EXECUTOR_MANAGER_BASE_URL=http://executor-manager:3010
      - PGHOST=pgsql
      - PGPORT=5432
      - PGUSER=app
      - PGPASSWORD=app123456
      - PGDATABASE=app
    depends_on:
      - pgsql
      - executor-manager
    networks:
      - agent-network
    restart: always

  executor:
    build:
      context: .
      dockerfile: ./executor/Dockerfile
    image: executor:latest
    container_name: executor
    ports:
      - "8090:8090"
    environment:
      - EXECUTOR_PORT=8090
      - EXECUTOR_AUTH_TOKEN=executor-secret
      - EXECUTOR_WORKSPACE_ROOT=/tmp/executor-workspaces
      - EXECUTOR_S3_ENDPOINT=http://rustfs:9000
      - EXECUTOR_S3_REGION=us-east-1
      - EXECUTOR_S3_FORCE_PATH_STYLE=true
      - EXECUTOR_S3_ACCESS_KEY=rustfsadmin
      - EXECUTOR_S3_SECRET_KEY=rustfsadmin
      - EXECUTOR_S3_BUCKET=app
      - EXECUTOR_PROVIDER_MODE=${EXECUTOR_PROVIDER_MODE:-real}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_AUTH_TOKEN=${ANTHROPIC_AUTH_TOKEN:-}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-}
      - OPENCODE_R2AI_API_KEY=${OPENCODE_R2AI_API_KEY:-}
      - OPENCODE_R2AI_BASE_URL=${OPENCODE_R2AI_BASE_URL:-}
    volumes:
      - executor_workspace:/tmp/executor-workspaces
    depends_on:
      - rustfs
    networks:
      - agent-network
    restart: always

  mihomo:
    container_name: mihomo
    image: yilee01/mihomo-yacd:latest
    volumes:
      - ./mihomo/:/root/.config/mihomo/
    networks:
      - agent-network
    restart: always

  file-manager:
    container_name: file-manager
    image: filebrowser/filebrowser:latest
    user: "0:0"
    environment:
      - FB_NOAUTH=true
      - FB_BASEURL=/file-manager
    command:
      - --address=0.0.0.0
      - --port=80
      - --root=/srv
      - --database=/database/filebrowser.db
      - --config=/config/settings.json
      - --baseurl=/file-manager
    volumes:
      - executor_workspace:/srv/executor-workspaces
      - filebrowser_db:/database
      - filebrowser_config:/config
    networks:
      - agent-network
    restart: always

  gateway:
    container_name: gateway
    build:
      context: ./gateway
      dockerfile: Dockerfile
    image: gateway:latest
    ports:
      - "3001:3001"
    environment:
      - GATEWAY_PORT=3001
      - GATEWAY_CONTROL_PLANE_URL=http://control-plane:3000
      - GATEWAY_EXECUTOR_MANAGER_URL=http://executor-manager:3010
      - GATEWAY_UPSTREAM_TIMEOUT_MS=30000
    depends_on:
      - control-plane
      - executor-manager
    networks:
      - agent-network
    restart: always

  executor-manager:
    container_name: executor-manager
    build:
      context: ./executor-manager
      dockerfile: Dockerfile
    image: executor-manager:latest
    ports:
      - "3010:3010"
    environment:
      - EXECUTOR_MANAGER_PORT=3010
      - EXECUTOR_MANAGER_STORAGE=postgres
      - EXECUTOR_MANAGER_DOCKER=cli
      - EXECUTOR_BASE_URL=http://executor:8090
      - EXECUTOR_AUTH_TOKEN=executor-secret
      - EXECUTOR_TIMEOUT_MS=30000
      - EXECUTOR_RUN_TIMEOUT_MS=1800000
      - EXECUTOR_RUN_TIMEOUT_TEMPLATE_JSON=${EXECUTOR_RUN_TIMEOUT_TEMPLATE_JSON:-}
      - EXECUTOR_MAX_RETRIES=1
      - EXECUTOR_RETRY_DELAY_MS=200
      - EXECUTOR_RETRY_STATUS_CODES=500,502,503,504
      - EXECUTOR_CONTAINER_IMAGE=executor:latest
      - EXECUTOR_CONTAINER_NETWORK=agent-network
      - PGHOST=pgsql
      - PGPORT=5432
      - PGUSER=app
      - PGPASSWORD=app123456
      - PGDATABASE=app
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - pgsql
      - executor
    networks:
      - agent-network
    restart: always

  portal:
    container_name: portal
    build:
      context: ./portal
      dockerfile: Dockerfile
    image: portal:latest
    ports:
      - "80:80"
    depends_on:
      - gateway
      - executor-manager
      - file-manager
      - mihomo
    networks:
      - agent-network
    restart: always

  prometheus:
    container_name: prometheus
    image: prom/prometheus:v2.55.1
    ports:
      - "9090:9090"
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./observability/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus_data:/prometheus
    depends_on:
      - control-plane
      - gateway
      - executor
      - executor-manager
      - alertmanager
    networks:
      - agent-network
    restart: always

  alertmanager:
    container_name: alertmanager
    image: prom/alertmanager:v0.27.0
    ports:
      - "9093:9093"
    command:
      - --config.file=/etc/alertmanager/alertmanager.yml
      - --storage.path=/alertmanager
    volumes:
      - ./observability/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager_data:/alertmanager
    depends_on:
      - gateway
    networks:
      - agent-network
    restart: always

  loki:
    container_name: loki
    image: grafana/loki:2.9.8
    command:
      - -config.file=/etc/loki/loki-config.yml
    ports:
      - "3100:3100"
    volumes:
      - ./observability/loki-config.yml:/etc/loki/loki-config.yml:ro
      - loki_data:/loki
    networks:
      - agent-network
    restart: always

  promtail:
    container_name: promtail
    image: grafana/promtail:2.9.8
    command:
      - -config.file=/etc/promtail/promtail-config.yml
    volumes:
      - ./observability/promtail-config.yml:/etc/promtail/promtail-config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - loki
    networks:
      - agent-network
    restart: always

  grafana:
    container_name: grafana
    image: grafana/grafana:11.1.5
    ports:
      - "3002:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    volumes:
      - ./observability/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./observability/grafana/dashboards:/etc/grafana/provisioning/dashboards/json:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
      - loki
    networks:
      - agent-network
    restart: always

  dozzle:
    container_name: dozzle
    image: amir20/dozzle:latest
    ports:
      - "3003:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - gateway
      - control-plane
      - executor-manager
      - executor
    networks:
      - agent-network
    restart: always

  pgsql:
    container_name: pgsql
    image: docker.m.daocloud.io/library/postgres:16-alpine
    environment:
      - POSTGRES_DB=app
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=app123456
    ports:
      - "5432:5432"
    volumes:
      - pgsql_data:/var/lib/postgresql/data
      - ./control-plane/sql/001_init.sql:/docker-entrypoint-initdb.d/001_init.sql:ro
      - ./control-plane/sql/002_rbac_and_file_acl.sql:/docker-entrypoint-initdb.d/002_rbac_and_file_acl.sql:ro
      - ./control-plane/sql/003_chat_history.sql:/docker-entrypoint-initdb.d/003_chat_history.sql:ro
      - ./control-plane/sql/004_app_runtime_profiles.sql:/docker-entrypoint-initdb.d/004_app_runtime_profiles.sql:ro
    networks:
      - agent-network
    restart: always

  rustfs:
    container_name: rustfs
    image: rustfs/rustfs:latest
    command: /data
    environment:
      - RUSTFS_ACCESS_KEY=rustfsadmin
      - RUSTFS_SECRET_KEY=rustfsadmin
    ports:
      - "19000:9000"
      - "19001:9001"
    volumes:
      - rustfs_data:/data
    networks:
      - agent-network
    restart: always

networks:
  agent-network:
    driver: bridge

volumes:
  alertmanager_data:
  filebrowser_db:
  filebrowser_config:
  executor_workspace:
  grafana_data:
  loki_data:
  pgsql_data:
  prometheus_data:
  rustfs_data:
