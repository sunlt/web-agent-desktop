services:
  agent-runtime:
    build:
      context: .
      dockerfile: ./dockerfile
    image: agent-runtime:latest
    container_name: agent-runtime
    ports:
      - "4096:4096"
    volumes:
      - agent_runtime_data:/root
      - ./ssh:/root/.ssh:ro
    environment:
      - HTTP_PROXY=http://mihomo:7890
      - HTTPS_PROXY=http://mihomo:7890
      - ALL_PROXY=socks5://mihomo:7890
      - http_proxy=http://mihomo:7890
      - https_proxy=http://mihomo:7890
      - all_proxy=socks5://mihomo:7890
    networks:
      - agent-network
    restart: always

  wetty:
    container_name: wetty
    image: wettyoss/wetty:latest
    depends_on:
      - agent-runtime
    volumes:
      - ./ssh/id_ed25519:/root/.ssh/id_ed25519:ro
    command: --host 0.0.0.0 --port 3000 --base /wetty --allow-iframe --command "ssh -i /root/.ssh/id_ed25519 -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@agent-runtime"
    networks:
      - agent-network
    restart: always

  mihomo:
    container_name: mihomo
    image: yilee01/mihomo-yacd:latest
    volumes:
      - ./mihomo/:/root/.config/mihomo/
    networks:
      - agent-network
    restart: always

  file-manager:
    container_name: file-manager
    image: filebrowser/filebrowser:latest
    user: "0:0"
    environment:
      - FB_NOAUTH=true
      - FB_BASEURL=/file-manager
    command:
      - --address=0.0.0.0
      - --port=80
      - --root=/srv
      - --database=/database/filebrowser.db
      - --config=/config/settings.json
      - --baseurl=/file-manager
    volumes:
      - agent_runtime_data:/srv
      - filebrowser_db:/database
      - filebrowser_config:/config
    networks:
      - agent-network
    restart: always

  portal:
    container_name: portal
    image: docker.m.daocloud.io/library/nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./portal:/usr/share/nginx/html
      - ./portal/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - agent-network
    restart: always

networks:
  agent-network:
    driver: bridge

volumes:
  filebrowser_db:
  filebrowser_config:
  agent_runtime_data:
